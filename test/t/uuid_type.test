# Setup: Copy VEB to veb_dir if VSQL_UUID_VEB is set, then install extension
--let $veb_dest = `SELECT CONCAT(@@veb_dir, '/vsql_uuid.veb')`
if ($VSQL_UUID_VEB) {
  --error 0,1
  --remove_file $veb_dest
  --copy_file $VSQL_UUID_VEB $veb_dest
}
INSTALL EXTENSION vsql_uuid;

--echo #
--echo # Test UUID type functionality
--echo #

# Create test table with UUID column
CREATE TEMPORARY TABLE uuid_test (
    id INT AUTO_INCREMENT PRIMARY KEY,
    uuid_col UUID,
    name VARCHAR(50)
);

# Test inserting various UUID string formats into UUID column
# UUID columns automatically encode string UUIDs to binary via the type's encode function
INSERT INTO uuid_test (uuid_col, name) VALUES
    ('550e8400-e29b-41d4-a716-446655440000', 'lowercase'),
    ('6BA7B810-9DAD-11D1-80B4-00C04FD430C8', 'uppercase'),
    ('f47ac10b-58CC-4372-A567-0e02b2c3d479', 'mixed_case'),
    ('00000000-0000-0000-0000-000000000000', 'nil_uuid'),
    ('ffffffff-ffff-ffff-ffff-ffffffffffff', 'max_uuid');

# Test selecting UUID values (should convert back to strings)
SELECT uuid_col, name FROM uuid_test ORDER BY id;

# Test UUID comparison and ordering with type
SELECT uuid_col, name FROM uuid_test ORDER BY uuid_col;

# Test UUID equality with different case inputs
SELECT COUNT(*) AS exact_match FROM uuid_test WHERE uuid_col = '550e8400-e29b-41d4-a716-446655440000';
SELECT COUNT(*) AS case_insensitive FROM uuid_test WHERE uuid_col = '550E8400-E29B-41D4-A716-446655440000';

# Test UUID type works with conversion functions
SET @test_uuid = '550e8400-e29b-41d4-a716-446655440000';
INSERT INTO uuid_test (uuid_col, name) VALUES
    (vsql_uuid.uuid_to_binary(vsql_uuid.binary_to_uuid(vsql_uuid.uuid_to_binary(@test_uuid))),
    'roundtrip_conversion');

# Test UUID comparison using uuid_compare function (compares string UUIDs)
SELECT vsql_uuid.uuid_compare('550e8400-e29b-41d4-a716-446655440000', '550e8400-e29b-41d4-a716-446655440000') = 0 AS compare_equal;
SELECT vsql_uuid.uuid_compare('550e8400-e29b-41d4-a716-446655440000', '00000000-0000-0000-0000-000000000000') > 0 AS compare_greater;

# Test UUID type with namespace-based generation (deterministic - same inputs = same output)
INSERT INTO uuid_test (uuid_col, name) VALUES
    (vsql_uuid.uuid_generate_v3('6ba7b810-9dad-11d1-80b4-00c04fd430c8', 'test'), 'v3_generated'),
    (vsql_uuid.uuid_generate_v5('6ba7b810-9dad-11d1-80b4-00c04fd430c8', 'test'), 'v5_generated');

# Test NULL handling
INSERT INTO uuid_test (uuid_col, name) VALUES (NULL, 'null_test');
SELECT uuid_col IS NULL AS is_null, name FROM uuid_test WHERE name = 'null_test';

# Test UUID type validation on insert (invalid format should fail)
--error ER_TRUNCATED_WRONG_VALUE_FOR_FIELD
INSERT INTO uuid_test (uuid_col, name) VALUES ('invalid-uuid-format', 'invalid_format');

# Test UUID type with empty string (should fail)
--error ER_TRUNCATED_WRONG_VALUE_FOR_FIELD
INSERT INTO uuid_test (uuid_col, name) VALUES ('', 'empty_string');

# Test UUID type range operations
SELECT COUNT(*) AS count_between FROM uuid_test
WHERE uuid_col BETWEEN '00000000-0000-0000-0000-000000000000' AND 'ffffffff-ffff-ffff-ffff-ffffffffffff';

# Test UUID type in WHERE clauses with various operators
SELECT name FROM uuid_test WHERE uuid_col = '550e8400-e29b-41d4-a716-446655440000' ORDER BY name;
SELECT name FROM uuid_test WHERE uuid_col != '550e8400-e29b-41d4-a716-446655440000' AND uuid_col IS NOT NULL ORDER BY name;
SELECT name FROM uuid_test WHERE uuid_col > '550e8400-e29b-41d4-a716-446655440000' ORDER BY name;
SELECT name FROM uuid_test WHERE uuid_col < '550e8400-e29b-41d4-a716-446655440000' ORDER BY name;

# Test UUID type in GROUP BY and DISTINCT
SELECT uuid_col, COUNT(*) AS count FROM uuid_test WHERE uuid_col IS NOT NULL GROUP BY uuid_col ORDER BY uuid_col;
SELECT DISTINCT uuid_col FROM uuid_test WHERE uuid_col IS NOT NULL ORDER BY uuid_col;

# Test UUID type with JOIN operations
CREATE TEMPORARY TABLE uuid_lookup (
    uuid_key UUID,
    description VARCHAR(100)
);

INSERT INTO uuid_lookup (uuid_key, description) VALUES
    ('550e8400-e29b-41d4-a716-446655440000', 'Primary test UUID'),
    ('6ba7b810-9dad-11d1-80b4-00c04fd430c8', 'Secondary test UUID');

SELECT u.uuid_col, u.name, l.description
FROM uuid_test u
LEFT JOIN uuid_lookup l ON u.uuid_col = l.uuid_key
WHERE u.uuid_col IS NOT NULL
ORDER BY u.uuid_col;

DROP TABLE uuid_lookup;

--echo #
--echo # Test UUID generation functions (non-deterministic)
--echo #

# Test generated UUIDs - these are random so we only verify they insert successfully
INSERT INTO uuid_test (uuid_col, name) VALUES
    (vsql_uuid.uuid_generate(), 'generated_v4'),
    (vsql_uuid.uuid_generate_v1(), 'generated_v1'),
    (vsql_uuid.uuid_generate_v1mc(), 'generated_v1mc'),
    (vsql_uuid.uuid_generate_v4(), 'generated_v4_explicit');

# Verify generated UUIDs were inserted (check by name, not UUID value)
SELECT COUNT(*) AS generated_count FROM uuid_test WHERE name LIKE 'generated%';
SELECT name FROM uuid_test WHERE name LIKE 'generated%' ORDER BY name;

# Verify generated UUIDs are valid
SELECT vsql_uuid.uuid_is_valid(vsql_uuid.binary_to_uuid(uuid_col)) AS is_valid, name
FROM uuid_test WHERE name LIKE 'generated%' ORDER BY name;

# Cleanup
DROP TABLE uuid_test;

# Uninstall extension
UNINSTALL EXTENSION vsql_uuid;
